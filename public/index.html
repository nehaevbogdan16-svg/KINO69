<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–æ–º–Ω–∞—Ç–∞ ‚Äî –ö–ò–ù–û69</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="top">
    <input id="videoUrl" placeholder="YouTube / VK / Rutube">
    <button id="setBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <button id="shareBtn">üì∫ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —ç–∫—Ä–∞–Ω–æ–º</button>
</div>

<div class="container">
    <div class="player">

        <!-- YouTube -->
        <div id="ytPlayer" style="display:none;"></div>

        <!-- WebRTC video -->
        <video id="screenVideo" autoplay playsinline style="display:none; width:100%; height:450px;"></video>

    </div>

    <div class="chat">
        <div id="messages"></div>
        <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
        <button onclick="sendChat()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
const socket = io();
const room = new URLSearchParams(location.search).get("room");

socket.emit("join-room", room);

/* ================= YOUTUBE ================= */

let ytPlayer;
let syncing = false;

function onYouTubeIframeAPIReady() {}

function loadYouTube(videoId) {
    document.getElementById("screenVideo").style.display = "none";
    document.getElementById("ytPlayer").style.display = "block";

    ytPlayer = new YT.Player("ytPlayer", {
        height: "450",
        width: "100%",
        videoId,
        events: {
            onStateChange: onYTState
        }
    });
}

function onYTState(e) {
    if (syncing) return;

    if (e.data === YT.PlayerState.PLAYING) {
        socket.emit("yt-play", { room, time: ytPlayer.getCurrentTime() });
    }
    if (e.data === YT.PlayerState.PAUSED) {
        socket.emit("yt-pause", { room, time: ytPlayer.getCurrentTime() });
    }
}

socket.on("yt-play", data => {
    syncing = true;
    ytPlayer.seekTo(data.time, true);
    ytPlayer.playVideo();
    syncing = false;
});

socket.on("yt-pause", data => {
    syncing = true;
    ytPlayer.pauseVideo();
    syncing = false;
});

/* ================= SCREEN SHARING (VK / RUTUBE) ================= */

let pc;
let localStream;
const screenVideo = document.getElementById("screenVideo");

document.getElementById("shareBtn").onclick = async () => {
    localStream = await navigator.mediaDevices.getDisplayMedia({
        video: true,
        audio: true
    });

    screenVideo.srcObject = localStream;
    screenVideo.style.display = "block";
    document.getElementById("ytPlayer").style.display = "none";

    pc = new RTCPeerConnection();

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.onicecandidate = e => {
        if (e.candidate) socket.emit("ice", { room, c: e.candidate });
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    socket.emit("offer", { room, offer });
};

socket.on("offer", async data => {
    pc = new RTCPeerConnection();

    pc.ontrack = e => {
        screenVideo.srcObject = e.streams[0];
        screenVideo.style.display = "block";
    };

    pc.onicecandidate = e => {
        if (e.candidate) socket.emit("ice", { room, c: e.candidate });
    };

    await pc.setRemoteDescription(data.offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit("answer", { room, answer });
});

socket.on("answer", data => {
    pc.setRemoteDescription(data.answer);
});

socket.on("ice", data => {
    pc.addIceCandidate(data.c);
});

/* ================= LOAD VIDEO ================= */

document.getElementById("setBtn").onclick = () => {
    const link = document.getElementById("videoUrl").value;

    const yt = link.match(/(?:v=|youtu\.be\/)([\w-]+)/);
    if (yt) {
        socket.emit("load-yt", { room, id: yt[1] });
        return;
    }

    alert("–î–ª—è VK / Rutube –Ω–∞–∂–º–∏ ¬´–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —ç–∫—Ä–∞–Ω–æ–º¬ª");
};

socket.on("load-yt", data => loadYouTube(data.id));

/* ================= CHAT ================= */

function sendChat() {
    const msg = document.getElementById("msg").value;
    socket.emit("chat", { room, msg });
}

socket.on("chat", data => {
    const d = document.createElement("div");
    d.textContent = data.msg;
    messages.appendChild(d);
});
</script>

</body>
</html>
