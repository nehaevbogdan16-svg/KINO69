<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–æ–º–Ω–∞—Ç–∞ ‚Äî –ö–ò–ù–û69</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="top">
    <input id="videoUrl" placeholder="YouTube / VK / Rutube / Vimeo / Dailymotion">
    <button id="setBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>

<div class="container">
    <div class="player">

        <!-- üé¨ –ï–î–ò–ù–´–ô –ü–õ–ï–ï–† -->
        <iframe
            id="player"
            width="100%"
            height="450"
            frameborder="0"
            allowfullscreen>
        </iframe>

    </div>

    <!-- üé§ –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ -->
    <div class="voice-controls" style="text-align:center; margin:10px 0;">
        <button id="micBtn">üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
    </div>

    <div class="chat">
        <div id="messages"></div>
        <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
        <button onclick="sendChat()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
const socket = io();
const room = new URLSearchParams(location.search).get("room");
const btn = document.getElementById("setBtn");
const input = document.getElementById("videoUrl");
const iframe = document.getElementById("player");

socket.emit("join-room", room);

/* ===== –í–ò–î–ï–û ===== */
btn.onclick = () => {
    const link = input.value.trim();
    let m, src = null;

    m = link.match(/video(-?\d+)_(\d+)/);
    if (m) src = `https://vk.com/video_ext.php?oid=${m[1]}&id=${m[2]}`;

    m = link.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
    if (m) src = `https://www.youtube.com/embed/${m[1]}`;

    m = link.match(/rutube\.ru\/video\/([a-zA-Z0-9]+)/);
    if (m) src = `https://rutube.ru/play/embed/${m[1]}`;

    m = link.match(/vimeo\.com\/(\d+)/);
    if (m) src = `https://player.vimeo.com/video/${m[1]}`;

    m = link.match(/dailymotion\.com\/video\/([a-zA-Z0-9]+)/);
    if (m) src = `https://www.dailymotion.com/embed/video/${m[1]}`;

    if (!src) {
        alert("‚ùå –°—Å—ã–ª–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
        return;
    }

    socket.emit("set-video", { room, src });
};

socket.on("set-video", data => {
    iframe.src = data.src;
});

/* ===== –ß–ê–¢ ===== */
function sendChat() {
    const msg = document.getElementById("msg").value;
    socket.emit("chat", { room, msg });
}

socket.on("chat", data => {
    const div = document.createElement("div");
    div.textContent = data.msg;
    document.getElementById("messages").appendChild(div);
});

/* ===== –ú–ò–ö–†–û–§–û–ù (–í–ö–õ / –í–´–ö–õ) ===== */
let micStream = null;
let micEnabled = false;
const micBtn = document.getElementById("micBtn");

micBtn.onclick = async () => {
    if (!micEnabled) {
        try {
            micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            micEnabled = true;
            micBtn.textContent = "üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";
            console.log("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á—ë–Ω");
        } catch (e) {
            alert("‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É");
        }
    } else {
        micStream.getTracks().forEach(t => t.stop());
        micEnabled = false;
        micBtn.textContent = "üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";
        console.log("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω");
    }
};
</script>

</body>
</html>
