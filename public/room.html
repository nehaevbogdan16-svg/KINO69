<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–æ–º–Ω–∞—Ç–∞ ‚Äî –ö–ò–ù–û69</title>
<link rel="stylesheet" href="/css/style.css">
<script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>

<div class="top">
    <div class="logo">–ö–ò–ù–û<span>69</span></div>
    <input id="videoUrl" placeholder="YouTube —Å—Å—ã–ª–∫–∞">
    <button id="setBtn">‚ñ∂</button>
</div>

<div class="container">
    <div class="player">
        <div id="yt"></div>
    </div>

    <div class="chat">
        <div id="messages"></div>
        <div class="chat-controls">
            <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
            <button onclick="sendChat()">‚û§</button>
            <button id="micBtn">üé§</button>
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
const room = new URLSearchParams(location.search).get("room");
socket.emit("join-room", room);

let ytPlayer, ytReady=false, isSyncing=false;

/* ===== YouTube ===== */
function onYouTubeIframeAPIReady() {
  ytPlayer = new YT.Player("yt", {
    height:"100%",
    width:"100%",
    playerVars:{controls:1},
    events:{
      onReady:()=>ytReady=true,
      onStateChange:onYTState
    }
  });
}

function onYTState(e){
  if(isSyncing) return;
  if(e.data===YT.PlayerState.PLAYING||e.data===YT.PlayerState.PAUSED){
    socket.emit("sync",{
      room,
      action:e.data===1?"play":"pause",
      time:ytPlayer.getCurrentTime()
    });
  }
}

socket.on("sync",d=>{
  if(!ytReady) return;
  isSyncing=true;
  ytPlayer.seekTo(d.time,true);
  d.action==="play"?ytPlayer.playVideo():ytPlayer.pauseVideo();
  setTimeout(()=>isSyncing=false,300);
});

/* ===== –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ ===== */
setBtn.onclick=()=>{
  const id=videoUrl.value.match(/(?:v=|be\/)([\w-]+)/)?.[1];
  if(!id) return alert("–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞");
  ytPlayer.loadVideoById(id);
};

/* ===== –ß–ê–¢ ===== */
function sendChat(){
  const msg=document.getElementById("msg");
  socket.emit("chat",{room,msg:msg.value});
  msg.value="";
}
socket.on("chat",d=>{
  const div=document.createElement("div");
  div.textContent=d.msg;
  messages.appendChild(div);
});

/* ===== –ì–û–õ–û–° ===== */
let stream=null,peers={},mic=false;
const ice={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

micBtn.onclick=async()=>{
  if(!mic){
    stream=await navigator.mediaDevices.getUserMedia({audio:true});
    socket.emit("voice-join",room);
    micBtn.textContent="üîá"; mic=true;
  }else{
    stream.getTracks().forEach(t=>t.stop());
    socket.emit("voice-leave",room);
    micBtn.textContent="üé§"; mic=false;
  }
};

function peer(id,init){
  const pc=new RTCPeerConnection(ice);
  peers[id]=pc;
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));
  pc.onicecandidate=e=>e.candidate&&socket.emit("ice",{to:id,candidate:e.candidate});
  pc.ontrack=e=>{
    const a=document.createElement("audio");
    a.srcObject=e.streams[0]; a.autoplay=true;
    document.body.appendChild(a);
  };
  if(init) pc.createOffer().then(o=>{pc.setLocalDescription(o);socket.emit("offer",{to:id,offer:o})});
}

socket.on("voice-users",u=>u.forEach(id=>peer(id,true)));
socket.on("offer",async d=>{
  peer(d.from,false);
  await peers[d.from].setRemoteDescription(d.offer);
  const a=await peers[d.from].createAnswer();
  await peers[d.from].setLocalDescription(a);
  socket.emit("answer",{to:d.from,answer:a});
});
socket.on("answer",d=>peers[d.from].setRemoteDescription(d.answer));
socket.on("ice",d=>peers[d.from]?.addIceCandidate(d.candidate));
socket.on("voice-leave",id=>{peers[id]?.close();delete peers[id];});
</script>
</body>
</html>
