<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–æ–º–Ω–∞—Ç–∞ ‚Äî –ö–ò–ù–û69</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="top">
    <input id="videoUrl" placeholder="YouTube / VK / Rutube / Vimeo / Dailymotion">
    <button id="setBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>

<div class="container">
    <div class="player">
        <iframe
            id="player"
            width="100%"
            height="450"
            frameborder="0"
            allowfullscreen>
        </iframe>
    </div>

    <!-- üé§ –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ -->
    <div class="voice-controls">
        <button id="micBtn">üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω</button>
    </div>

    <div class="chat">
        <div id="messages"></div>
        <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
        <button onclick="sendChat()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
/* =====================================================
   –û–°–ù–û–í–ù–û–ô –ö–û–î
   ===================================================== */
const socket = io();
const room = new URLSearchParams(location.search).get("room");

const btn = document.getElementById("setBtn");
const input = document.getElementById("videoUrl");
const iframe = document.getElementById("player");

socket.emit("join-room", room);

btn.onclick = () => {
    const link = input.value.trim();
    let m, src = null;

    m = link.match(/video(-?\d+)_(\d+)/);
    if (m) src = `https://vk.com/video_ext.php?oid=${m[1]}&id=${m[2]}`;

    m = link.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
    if (m) src = `https://www.youtube.com/embed/${m[1]}`;

    m = link.match(/rutube\.ru\/video\/([a-zA-Z0-9]+)/);
    if (m) src = `https://rutube.ru/play/embed/${m[1]}`;

    m = link.match(/vimeo\.com\/(\d+)/);
    if (m) src = `https://player.vimeo.com/video/${m[1]}`;

    m = link.match(/dailymotion\.com\/video\/([a-zA-Z0-9]+)/);
    if (m) src = `https://www.dailymotion.com/embed/video/${m[1]}`;

    if (!src) return alert("‚ùå –°—Å—ã–ª–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");

    socket.emit("set-video", { room, src });
};

socket.on("set-video", data => {
    iframe.src = data.src;
});

/* ===== –ß–ê–¢ ===== */
function sendChat() {
    const msg = document.getElementById("msg").value;
    socket.emit("chat", { room, msg });
}

socket.on("chat", data => {
    const div = document.createElement("div");
    div.textContent = data.msg;
    document.getElementById("messages").appendChild(div);
});

/* =====================================================
   üé§ WEBRTC –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢
   ===================================================== */
let localStream = null;
let peers = {};
let micEnabled = false;

const micBtn = document.getElementById("micBtn");

const iceConfig = {
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

micBtn.onclick = async () => {
    if (!micEnabled) {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        socket.emit("voice-join", room);
        micBtn.textContent = "üîá –í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";
        micEnabled = true;
    } else {
        localStream.getTracks().forEach(t => t.stop());
        socket.emit("voice-leave", room);
        micBtn.textContent = "üé§ –í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω";
        micEnabled = false;
    }
};

function createPeer(id, initiator) {
    const pc = new RTCPeerConnection(iceConfig);
    peers[id] = pc;

    localStream.getTracks().forEach(track =>
        pc.addTrack(track, localStream)
    );

    pc.onicecandidate = e => {
        if (e.candidate) {
            socket.emit("ice", { to: id, candidate: e.candidate });
        }
    };

    pc.ontrack = e => {
        const audio = document.createElement("audio");
        audio.srcObject = e.streams[0];
        audio.autoplay = true;
        document.body.appendChild(audio);
    };

    if (initiator) {
        pc.createOffer().then(offer => {
            pc.setLocalDescription(offer);
            socket.emit("offer", { to: id, offer });
        });
    }
}

socket.on("voice-users", users => {
    users.forEach(id => createPeer(id, true));
});

socket.on("offer", async data => {
    createPeer(data.from, false);
    await peers[data.from].setRemoteDescription(data.offer);
    const answer = await peers[data.from].createAnswer();
    await peers[data.from].setLocalDescription(answer);
    socket.emit("answer", { to: data.from, answer });
});

socket.on("answer", data => {
    peers[data.from].setRemoteDescription(data.answer);
});

socket.on("ice", data => {
    peers[data.from]?.addIceCandidate(data.candidate);
});

socket.on("voice-leave", id => {
    if (peers[id]) {
        peers[id].close();
        delete peers[id];
    }
});
</script>

</body>
</html>
