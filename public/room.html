<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Комната — КИНО69</title>
<link rel="stylesheet" href="/css/style.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<div class="top">
    <input id="videoUrl" placeholder="YouTube / VK / Rutube / Vimeo / Dailymotion">
    <button id="setBtn">Загрузить</button>
</div>

<div class="container">
    <div class="player">

        <!-- YouTube API player -->
        <div id="ytPlayer" style="display:none; width:100%; height:450px;"></div>

        <!-- Обычный iframe для остальных -->
        <iframe
            id="iframePlayer"
            width="100%"
            height="450"
            frameborder="0"
            allowfullscreen
            style="display:none;">
        </iframe>

    </div>

    <div class="chat">
        <div id="messages"></div>
        <input id="msg" placeholder="Сообщение">
        <button onclick="sendChat()">Отправить</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
const socket = io();
const room = new URLSearchParams(location.search).get("room");

socket.emit("join-room", room);

const input = document.getElementById("videoUrl");
const btn = document.getElementById("setBtn");
const iframe = document.getElementById("iframePlayer");
const ytDiv = document.getElementById("ytPlayer");

let ytPlayer;
let ignore = false;

/* ================= YOUTUBE API ================= */

function onYouTubeIframeAPIReady() {
  // API готов, плеер создаётся динамически
}

function loadYouTube(videoId) {
  iframe.style.display = "none";
  ytDiv.style.display = "block";

  if (ytPlayer) {
    ytPlayer.loadVideoById(videoId);
    return;
  }

  ytPlayer = new YT.Player("ytPlayer", {
    videoId,
    events: {
      onStateChange: onYTState
    }
  });
}

function onYTState(e) {
  if (ignore) return;

  const time = ytPlayer.getCurrentTime();

  if (e.data === YT.PlayerState.PLAYING) {
    socket.emit("yt-play", { room, time });
  }

  if (e.data === YT.PlayerState.PAUSED) {
    socket.emit("yt-pause", { room, time });
  }
}

socket.on("load-yt", d => {
  ignore = true;
  loadYouTube(d.id);
  setTimeout(() => ignore = false, 300);
});

socket.on("yt-play", d => {
  if (!ytPlayer) return;
  ignore = true;
  ytPlayer.seekTo(d.time, true);
  ytPlayer.playVideo();
  setTimeout(() => ignore = false, 300);
});

socket.on("yt-pause", d => {
  if (!ytPlayer) return;
  ignore = true;
  ytPlayer.pauseVideo();
  setTimeout(() => ignore = false, 300);
});

/* ================= ЗАГРУЗКА ВИДЕО ================= */

btn.onclick = () => {
  const link = input.value.trim();
  let m, src;

  // ▶ YouTube
  m = link.match(/(?:v=|youtu\.be\/)([\w-]+)/);
  if (m) {
    socket.emit("load-yt", { room, id: m[1] });
    return;
  }

  ytDiv.style.display = "none";
  iframe.style.display = "block";

  // ▶ VK
  m = link.match(/video(-?\d+)_(\d+)/);
  if (m) src = `https://vk.com/video_ext.php?oid=${m[1]}&id=${m[2]}`;

  // ▶ Rutube
  m = link.match(/rutube\.ru\/video\/([\w\d]+)/);
  if (m) src = `https://rutube.ru/play/embed/${m[1]}`;

  // ▶ Vimeo
  m = link.match(/vimeo\.com\/(\d+)/);
  if (m) src = `https://player.vimeo.com/video/${m[1]}`;

  // ▶ Dailymotion
  m = link.match(/dailymotion\.com\/video\/([\w\d]+)/);
  if (m) src = `https://www.dailymotion.com/embed/video/${m[1]}`;

  if (!src) {
    alert("❌ Ссылка не поддерживается");
    return;
  }

  socket.emit("set-video", { room, src });
};

socket.on("set-video", d => {
  iframe.src = d.src;
});

/* ================= ЧАТ ================= */

function sendChat() {
  const msg = document.getElementById("msg").value;
  socket.emit("chat", { room, msg });
}

socket.on("chat", d => {
  const div = document.createElement("div");
  div.textContent = d.msg;
  messages.appendChild(div);
});
</script>

</body>
</html>
