<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö–æ–º–Ω–∞—Ç–∞ ‚Äî –ö–ò–ù–û69</title>
<link rel="stylesheet" href="/css/style.css">
<script src="https://www.youtube.com/iframe_api"></script>
</head>

<body>

<!-- üîù –®–ê–ü–ö–ê -->
<div class="top">
    <div class="logo">
        <span class="logo-text">–ö–ò–ù–û</span><span class="logo-accent">69</span>
    </div>

    <div class="top-controls">
        <input id="videoUrl" placeholder="YouTube / VK / Rutube / Vimeo / Dailymotion">
        <button id="setBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
</div>

<!-- üé¨ –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ -->
<div class="container">

    <!-- –ü–õ–ï–ï–† -->
    <div class="player">
        <!-- YouTube API -->
        <div id="yt-player" style="display:none; width:100%; height:100%;"></div>

        <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã -->
        <iframe
            id="iframe-player"
            allowfullscreen>
        </iframe>
    </div>

    <!-- –ß–ê–¢ -->
    <div class="chat">
        <div id="messages"></div>

        <div class="chat-controls">
            <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
            <button onclick="sendChat()">‚û§</button>

            <!-- üé§ –ú–ò–ö–†–û–§–û–ù -->
            <button id="micBtn" title="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">üé§</button>

            <!-- üîä –ì–†–û–ú–ö–û–°–¢–¨ -->
            <input type="range" id="voiceVolume" min="0" max="1" step="0.05" value="1">
        </div>
    </div>

</div>

<script src="/socket.io/socket.io.js"></script>

<script>
/* =====================================================
   SOCKET / –û–°–ù–û–í–ê
===================================================== */
const socket = io();
const room = new URLSearchParams(location.search).get("room");

socket.emit("join-room", room);

/* =====================================================
   –ü–õ–ï–ï–†
===================================================== */
const btn = document.getElementById("setBtn");
const input = document.getElementById("videoUrl");
const iframe = document.getElementById("iframe-player");
const ytDiv = document.getElementById("yt-player");

let ytPlayer;
let isYouTube = false;
let ignoreSync = false;

/* YouTube API */
function onYouTubeIframeAPIReady() {
    ytPlayer = new YT.Player("yt-player", {
        events: { onStateChange }
    });
}

function onStateChange(e) {
    if (ignoreSync) return;

    if (e.data === YT.PlayerState.PLAYING) {
        socket.emit("sync", {
            room,
            type: "play",
            time: ytPlayer.getCurrentTime()
        });
    }

    if (e.data === YT.PlayerState.PAUSED) {
        socket.emit("sync", {
            room,
            type: "pause",
            time: ytPlayer.getCurrentTime()
        });
    }
}

socket.on("sync", data => {
    if (!isYouTube || !ytPlayer) return;

    ignoreSync = true;

    ytPlayer.seekTo(data.time, true);
    data.type === "play" ? ytPlayer.playVideo() : ytPlayer.pauseVideo();

    setTimeout(() => ignoreSync = false, 300);
});

/* –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ */
btn.onclick = () => {
    const link = input.value.trim();
    let m;

    // YouTube
    m = link.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
    if (m) {
        isYouTube = true;
        iframe.style.display = "none";
        ytDiv.style.display = "block";
        ytPlayer.loadVideoById(m[1]);
        return;
    }

    isYouTube = false;
    ytDiv.style.display = "none";
    iframe.style.display = "block";

    if ((m = link.match(/video(-?\d+)_(\d+)/)))
        iframe.src = `https://vk.com/video_ext.php?oid=${m[1]}&id=${m[2]}`;

    else if ((m = link.match(/rutube\.ru\/video\/([a-zA-Z0-9]+)/)))
        iframe.src = `https://rutube.ru/play/embed/${m[1]}`;

    else if ((m = link.match(/vimeo\.com\/(\d+)/)))
        iframe.src = `https://player.vimeo.com/video/${m[1]}`;

    else if ((m = link.match(/dailymotion\.com\/video\/([a-zA-Z0-9]+)/)))
        iframe.src = `https://www.dailymotion.com/embed/video/${m[1]}`;

    else alert("‚ùå –°—Å—ã–ª–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
};

/* =====================================================
   –ß–ê–¢
===================================================== */
function sendChat() {
    const msg = document.getElementById("msg");
    if (!msg.value) return;
    socket.emit("chat", { room, msg: msg.value });
    msg.value = "";
}

socket.on("chat", data => {
    const div = document.createElement("div");
    div.textContent = data.msg;
    document.getElementById("messages").appendChild(div);
});

/* =====================================================
   üé§ –ì–û–õ–û–°–û–í–û–ô –ß–ê–¢ WebRTC
===================================================== */
let localStream = null;
let peers = {};
let micOn = false;

const micBtn = document.getElementById("micBtn");
const volumeSlider = document.getElementById("voiceVolume");
let voiceVolume = 1;

const iceConfig = {
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

volumeSlider.oninput = e => {
    voiceVolume = e.target.value;
    document.querySelectorAll("audio.voice").forEach(a => a.volume = voiceVolume);
};

micBtn.onclick = async () => {
    if (!micOn) {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        socket.emit("voice-join", room);
        micBtn.textContent = "üîá";
        micOn = true;
    } else {
        localStream.getTracks().forEach(t => t.stop());
        socket.emit("voice-leave", room);
        micBtn.textContent = "üé§";
        micOn = false;
    }
};

function createPeer(id, initiator) {
    const pc = new RTCPeerConnection(iceConfig);
    peers[id] = pc;

    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    pc.onicecandidate = e => {
        if (e.candidate)
            socket.emit("ice", { to: id, candidate: e.candidate });
    };

    pc.ontrack = e => {
        const audio = document.createElement("audio");
        audio.srcObject = e.streams[0];
        audio.autoplay = true;
        audio.volume = voiceVolume;
        audio.className = "voice";
        document.body.appendChild(audio);
    };

    if (initiator) {
        pc.createOffer().then(o => {
            pc.setLocalDescription(o);
            socket.emit("offer", { to: id, offer: o });
        });
    }
}

socket.on("voice-users", users => users.forEach(id => createPeer(id, true)));
socket.on("offer", async d => {
    createPeer(d.from, false);
    await peers[d.from].setRemoteDescription(d.offer);
    const a = await peers[d.from].createAnswer();
    await peers[d.from].setLocalDescription(a);
    socket.emit("answer", { to: d.from, answer: a });
});
socket.on("answer", d => peers[d.from].setRemoteDescription(d.answer));
socket.on("ice", d => peers[d.from]?.addIceCandidate(d.candidate));
socket.on("voice-leave", id => {
    peers[id]?.close();
    delete peers[id];
});
</script>

</body>
</html>
