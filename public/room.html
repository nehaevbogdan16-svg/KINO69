<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–æ–º–Ω–∞—Ç–∞ ‚Äî –ö–ò–ù–û69</title>
<link rel="stylesheet" href="/css/style.css">
</head>
<body>

<div class="top">
    <input id="videoUrl" placeholder="YouTube / VK / Rutube / Vimeo / Dailymotion">
    <button id="setBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
</div>

<div class="container">
    <div class="player">

        <!-- üé¨ –ï–î–ò–ù–´–ô –ü–õ–ï–ï–† -->
        <iframe
            id="player"
            width="100%"
            height="450"
            frameborder="0"
            allowfullscreen>
        </iframe>

    </div>

    <div class="chat">
        <div id="messages"></div>
        <input id="msg" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
        <button onclick="sendChat()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>

<script>
const socket = io();
const room = new URLSearchParams(location.search).get("room");
const btn = document.getElementById("setBtn");
const input = document.getElementById("videoUrl");
const iframe = document.getElementById("player");

socket.emit("join-room", room);

btn.onclick = () => {
    const link = input.value.trim();
    let m, src = null;

    // ‚ñ∂ VK Video
    m = link.match(/video(-?\d+)_(\d+)/);
    if (m) {
        src = `https://vk.com/video_ext.php?oid=${m[1]}&id=${m[2]}`;
    }

    // ‚ñ∂ YouTube
    m = link.match(/(?:v=|youtu\.be\/)([a-zA-Z0-9_-]+)/);
    if (m) {
        src = `https://www.youtube.com/embed/${m[1]}`;
    }

    // ‚ñ∂ Rutube
    m = link.match(/rutube\.ru\/video\/([a-zA-Z0-9]+)/);
    if (m) {
        src = `https://rutube.ru/play/embed/${m[1]}`;
    }

    // ‚ñ∂ Vimeo
    m = link.match(/vimeo\.com\/(\d+)/);
    if (m) {
        src = `https://player.vimeo.com/video/${m[1]}`;
    }

    // ‚ñ∂ Dailymotion
    m = link.match(/dailymotion\.com\/video\/([a-zA-Z0-9]+)/);
    if (m) {
        src = `https://www.dailymotion.com/embed/video/${m[1]}`;
    }

    if (!src) {
        alert("‚ùå –°—Å—ã–ª–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
        return;
    }

    socket.emit("set-video", { room, src });
};

socket.on("set-video", data => {
    iframe.src = data.src;
});

/* ===== –ß–ê–¢ (–ø—Ä–∏–º–µ—Ä) ===== */
function sendChat() {
    const msg = document.getElementById("msg").value;
    socket.emit("chat", { room, msg });
}

socket.on("chat", data => {
    const div = document.createElement("div");
    div.textContent = data.msg;
    document.getElementById("messages").appendChild(div);
});
</script>

</body>
</html>
